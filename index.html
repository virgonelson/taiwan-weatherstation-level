<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>臺灣氣象站制縣等級</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            text-align: center;
        }
        h1 {
            font-size: 2em;
            color: #333;
            transition: color 0.3s;
        }
        h1:hover {
            color: #007bff;
        }
        #totalLevel {
            font-size: 1.2em;
            color: #333;
            margin: 10px 0;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        #map {
            height: 500px;
            width: 100%;
            max-width: 600px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: box-shadow 0.3s;
        }
        #map:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #legend {
            width: 200px;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-align: left;
        }
        #legend h3 {
            font-size: 1em;
            margin-bottom: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 14px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid #ccc;
        }
        .legend-controls {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
        }
        .control-button {
            padding: 8px 15px;
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }
        .control-button:hover {
            background-color: #e0e0e0;
        }
        footer {
            font-size: 0.9em;
            color: #666;
            margin-top: 20px;
        }
        .status-button {
            display: block;
            width: 140px; /* 增加寬度以容納新文字 */
            margin: 5px auto;
            padding: 5px;
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .status-button:hover {
            background-color: #e0e0e0;
        }
        .station-label {
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 1px #fff;
            white-space: nowrap;
        }
        .marker-background {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            top: -5px;
            left: -3px;
            z-index: -1;
        }
        @media (max-width: 900px) {
            #legend {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <h1>臺灣氣象站制縣等級</h1>
    <div id="totalLevel">制縣等級: 0</div>
    <div class="container">
        <div id="map"></div>
        <div id="legend">
            <h3>圖例</h3>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e84c3d;"></div>
                <span>住宿過 (等級 4)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f1c40f;"></div>
                <span>工作過 (等級 3)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #30cc70;"></div>
                <span>短期出差或訪問過 (等級 2)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3598db;"></div>
                <span>路過 (等級 1)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #bdc3c7;"></div>
                <span>沒去過 (等級 0)</span>
            </div>
            <div class="legend-controls">
                <button class="control-button" onclick="setUserName()">設定名字</button>
                <button class="control-button" onclick="takeScreenshot()">畫面截圖</button>
            </div>
        </div>
    </div>
    <footer>點選氣象站標記選擇到訪狀態，每次刷新網站計數歸零。 作者: Nelson</footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // 清空 LocalStorage 以確保刷新時歸零
        localStorage.removeItem("weatherStationVisits");
        localStorage.removeItem("userName");

        // 初始化用戶數據
        let userData = {};
        let userName = "";

        // 氣象站數據
        const stations = [
            {"name": "五分山雷達站", "address": "新北市瑞芳區靜安路四段1巷1號", "lat": 25.071182, "lon": 121.781205},
            {"name": "新北", "address": "新北市新店區莒光路29號", "lat": 24.959207, "lon": 121.525196},
            {"name": "淡水", "address": "新北市淡水區中正東路42巷6號", "lat": 25.164889, "lon": 121.448906},
            {"name": "鞍部", "address": "臺北市北投區陽明山竹子湖路111號", "lat": 25.182586, "lon": 121.529731},
            {"name": "臺北", "address": "臺北市中正區公園路64號", "lat": 25.037658, "lon": 121.514853},
            {"name": "竹子湖", "address": "臺北市北投區陽明山竹子湖路2號", "lat": 25.162078, "lon": 121.544547},
            {"name": "基隆", "address": "基隆市仁愛區港西街6號6樓(海港大樓6樓)", "lat": 25.133314, "lon": 121.740475},
            {"name": "彭佳嶼", "address": "基隆市中正區彭佳嶼", "lat": 25.627975, "lon": 122.079744},
            {"name": "花蓮", "address": "花蓮縣花蓮市花崗街24號", "lat": 23.975128, "lon": 121.613275},
            {"name": "新屋", "address": "桃園市新屋區東興路二段946號", "lat": 25.006725, "lon": 121.047492},
            {"name": "宜蘭", "address": "宜蘭縣宜蘭市力行路150號", "lat": 24.763975, "lon": 121.756528},
            {"name": "金門", "address": "金門縣金城鎮金水里西海路一段250號", "lat": 24.407306, "lon": 118.289281},
            {"name": "田中", "address": "彰化縣田中鎮中潭里4鄰高鐵三路1段167號", "lat": 23.873803, "lon": 120.581286},
            {"name": "後龍", "address": "苗栗縣造橋鄉龍昇村九車籠42-16號", "lat": 24.648563, "lon": 120.831834},
            {"name": "古坑", "address": "雲林縣古坑鄉永光村文昌路270號", "lat": 23.633639, "lon": 120.551889},
            {"name": "東吉島", "address": "澎湖縣望安鄉東吉村156號", "lat": 23.25727, "lon": 119.66762},
            {"name": "澎湖", "address": "澎湖縣馬公市新興路2號", "lat": 23.565503, "lon": 119.563094},
            {"name": "臺南", "address": "臺南市中西區公園路21號", "lat": 22.99328, "lon": 120.20492},
            {"name": "永康", "address": "臺南市永康區鹽行里正南五街520巷88號", "lat": 23.038386, "lon": 120.2367},
            {"name": "高雄", "address": "高雄市楠梓區德民路28號", "lat": 22.730432, "lon": 120.312516},
            {"name": "嘉義", "address": "嘉義市西區北新里海口寮路56號", "lat": 23.495925, "lon": 120.432906},
            {"name": "臺中", "address": "臺中市北區精武路295號", "lat": 24.145736, "lon": 120.684075},
            {"name": "阿里山", "address": "嘉義縣阿里山鄉中正村4鄰東阿里山73-1號", "lat": 23.508208, "lon": 120.813242},
            {"name": "大武", "address": "臺東縣大武鄉大武街115號", "lat": 22.35572, "lon": 120.90374},
            {"name": "玉山", "address": "南投縣信義鄉玉山北峰1號", "lat": 23.48718, "lon": 120.95943},
            {"name": "新竹", "address": "新竹縣竹北市北崙里3鄰光明五街60號", "lat": 24.827853, "lon": 121.014219},
            {"name": "恆春", "address": "屏東縣恆春鎮天文路50號", "lat": 22.003897, "lon": 120.746339},
            {"name": "成功", "address": "臺東縣成功鎮公民路84號", "lat": 23.097486, "lon": 121.373428},
            {"name": "蘭嶼", "address": "臺東縣蘭嶼鄉紅頭村2號", "lat": 22.0369, "lon": 121.55843},
            {"name": "日月潭", "address": "南投縣魚池鄉水社村中山路270巷14號", "lat": 23.881325, "lon": 120.90805},
            {"name": "臺東", "address": "臺東縣臺東市大同路106號", "lat": 22.752211, "lon": 121.154586},
            {"name": "墾丁雷達站", "address": "屏東縣恆春鎮燈塔路51巷33號", "lat": 21.948235, "lon": 120.808028},
            {"name": "馬祖", "address": "連江縣南竿鄉四維村6鄰88號", "lat": 26.169467, "lon": 119.923158}
        ];

        // 初始化用戶數據
        stations.forEach(station => {
            userData[station.name] = { level: 0, status: "沒去過" };
        });

        // 等級與顏色對應
        const levelColors = {
            4: "#e84c3d",  // 住宿過
            3: "#f1c40f",  // 工作過
            2: "#30cc70",  // 短期出差或訪問過
            1: "#3598db",  // 路過
            0: "#bdc3c7"   // 沒去過
        };

        // 計算總等級並更新顯示
        function calculateTotalLevel() {
            let total = 0;
            for (let station in userData) {
                total += userData[station].level;
            }
            const levelText = userName ? `${userName} 的制縣等級: ${total}` : `制縣等級: ${total}`;
            document.getElementById("totalLevel").textContent = levelText;
        }

        // 設定用戶名稱
        function setUserName() {
            const name = prompt("請輸入你的名字：");
            if (name) {
                userName = name;
                localStorage.setItem("userName", userName);
                calculateTotalLevel();
            }
        }

        // 畫面截圖
        function takeScreenshot() {
            const mapInstance = map;
            mapInstance.invalidateSize(); // 確保地圖尺寸正確
            mapInstance.once('load', () => {
                setTimeout(() => {
                    html2canvas(document.body, {
                        useCORS: true,
                        logging: true,
                        allowTaint: true,
                        foreignObjectRendering: true,
                        scale: 2 // 提升清晰度
                    }).then(canvas => {
                        const link = document.createElement("a");
                        link.download = `taiwan-weather-station-map-${new Date().toISOString().split("T")[0]}.png`;
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    }).catch(err => {
                        console.error("Screenshot error:", err);
                        alert("截圖失敗，請嘗試手動截圖（Windows: Win + Shift + S；macOS: Cmd + Shift + 4）。");
                    });
                }, 1500); // 延遲 1500ms 確保圖塊載入
            });
            // 觸發地圖重新載入
            mapInstance.fire('load');
        }

        // 初始化總等級
        calculateTotalLevel();

        // 初始化地圖
        const map = L.map("map").setView([24.0, 120.5], 7); // 中心向西北移動
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            crossOrigin: "anonymous" // 支援 CORS
        }).addTo(map);

        // 載入臺灣 GeoJSON
        fetch("https://raw.githubusercontent.com/tonytonyjan/taiwan-geojson/master/taiwan.json")
            .then(response => response.json())
            .then(geojson => {
                L.geoJSON(geojson, {
                    style: {
                        fillColor: "#3388ff",
                        weight: 1,
                        opacity: 1,
                        color: "white",
                        fillOpacity: 0.7
                    }
                }).addTo(map);
            });

        // 為每個氣象站添加標記
        stations.forEach(station => {
            const marker = L.marker([station.lat, station.lon], {
                icon: L.divIcon({
                    className: "custom-icon",
                    html: `
                        <div style="position: relative;">
                            <div class="marker-background"></div>
                            <i class="fa-solid fa-cloud-sun" style="font-size: 20px; color: ${levelColors[userData[station.name].level]};"></i>
                        </div>
                        <div class="station-label" style="margin-top: 5px;">${station.name}</div>
                    `,
                    iconSize: [30, 40],
                    iconAnchor: [15, 40]
                })
            }).addTo(map);

            // 點選標記顯示選擇按鈕
            marker.bindPopup(() => {
                const container = L.DomUtil.create("div");
                container.innerHTML = `
                    <b>${station.name}</b><br>
                    地址: ${station.address}<br>
                    <button class="status-button" data-level="4">住宿過</button>
                    <button class="status-button" data-level="3">工作過</button>
                    <button class="status-button" data-level="2">短期出差或訪問過</button>
                    <button class="status-button" data-level="1">路過</button>
                    <button class="status-button" data-level="0">沒去過</button>
                `;
                container.querySelectorAll(".status-button").forEach(button => {
                    L.DomEvent.addListener(button, "click", () => {
                        const level = parseInt(button.getAttribute("data-level"));
                        const status = ["沒去過", "路過", "短期出差或訪問過", "工作過", "住宿過"][level];
                        userData[station.name] = { level, status };
                        localStorage.setItem("weatherStationVisits", JSON.stringify(userData));
                        marker.setIcon(L.divIcon({
                            className: "custom-icon",
                            html: `
                                <div style="position: relative;">
                                    <div class="marker-background"></div>
                                    <i class="fa-solid fa-cloud-sun" style="font-size: 20px; color: ${levelColors[level]};"></i>
                                </div>
                                <div class="station-label" style="margin-top: 5px;">${station.name}</div>
                            `,
                            iconSize: [30, 40],
                            iconAnchor: [15, 40]
                        }));
                        calculateTotalLevel();
                        marker.closePopup();
                    });
                });
                return container;
            });
        });
    </script>
</body>
</html>